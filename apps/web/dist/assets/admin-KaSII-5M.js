import"./modulepreload-polyfill-B5Qt9EMX.js";function rt(n){return document.getElementById(n)}function st(n){n.style.display="flex",n.setAttribute("aria-hidden","false")}function ct(n){n.style.display="none",n.setAttribute("aria-hidden","true")}function _t(n,t,f){n.setAttribute("aria-invalid","true"),t.textContent=f,t.style.display="block"}function yt(n,t){n.removeAttribute("aria-invalid"),t.textContent="",t.style.display="none"}function Et(n){return String(n??"").trim()}function bt(n){return/^[a-z0-9]+(?:-[a-z0-9]+)*$/.test(n)}function Lt(n,{storageKey:t="ia_admin_token"}={}){if(!n)throw new Error("initAdminTokenInput: missing inputEl");n.value=localStorage.getItem(t)||"",n.addEventListener("input",()=>{localStorage.setItem(t,n.value||"")});function f(){return n.value||""}return{getToken:f,storageKey:t}}async function dt(n,{method:t="GET",token:f="",body:p=null}={}){const _={},E=p!=null;E&&(_["Content-Type"]="application/json"),f&&(_["x-admin-token"]=f);const l=await fetch(n,{method:t,headers:_,body:E?JSON.stringify(p):void 0}),M=await l.text();let y=null;try{y=M?JSON.parse(M):null}catch{y={raw:M}}if(!l.ok){const T=(y==null?void 0:y.message)||(y==null?void 0:y.error)||`HTTP ${l.status}`,I=new Error(T);throw I.status=l.status,I.detail=y,I}return y}function xt({$:n,openModal:t,closeModal:f}){if(typeof n!="function")throw new Error("initConfirm: missing $");if(typeof t!="function")throw new Error("initConfirm: missing openModal");if(typeof f!="function")throw new Error("initConfirm: missing closeModal");const p=n("confirmOverlay"),_=n("confirmTitle"),E=n("confirmBody"),l=n("confirmOk");if(!p||!_||!E||!l)throw new Error("initConfirm: confirm modal elements not found (check ids in admin.html)");function M(){let I=null;function e(){t(p)}function a(){f(p)}function v(g="录入中",w="请稍候…"){_.textContent=g,E.textContent=w,l.disabled=!0,e()}function L(g,w){_.textContent=g?"完成":"失败",E.textContent=w||"",l.disabled=!1,e()}function b(){return new Promise(g=>{I=g;const w=()=>{l.removeEventListener("click",w),a(),I&&I(!0),I=null};l.addEventListener("click",w)})}return{setLoading:v,setResult:L,waitAck:b}}const y=M();async function T({titleLoading:I,bodyLoading:e,action:a}){y.setLoading(I||"录入中",e||"请稍候…");try{const v=await a();y.setResult(!0,v||"✅ 成功")}catch(v){y.setResult(!1,`❌ 失败：${(v==null?void 0:v.message)||String(v)}`)}await y.waitAck()}return{confirm:y,showConfirmFlow:T}}function St({inputEl:n,listEl:t,statusEl:f,searchFn:p,renderItem:_,onPick:E,debounceMs:l=220,minQueryLen:M=1}){if(!n||!t||!f)throw new Error("createEntitySearch: missing inputEl/listEl/statusEl");let y=null,T="",I=0;function e(g){f.textContent=g||""}function a(){t.innerHTML=""}function v(g){if(a(),!g||g.length===0){const w=document.createElement("div");w.className="hint",w.textContent="没有匹配结果。",t.appendChild(w);return}for(const w of g){const{title:z,subtitle:k}=_(w)||{},h=document.createElement("div");h.style.border="1px solid rgba(0,0,0,.15)",h.style.borderRadius="10px",h.style.padding="10px",h.style.margin="8px 0",h.style.cursor="pointer",h.style.userSelect="none";const N=document.createElement("div");if(N.style.fontWeight="800",N.style.fontSize="14px",N.textContent=z||"（未命名）",h.appendChild(N),k){const u=document.createElement("div");u.style.marginTop="4px",u.style.fontSize="12px",u.style.color="rgba(0,0,0,.65)",u.textContent=k,h.appendChild(u)}h.addEventListener("click",()=>E&&E(w)),t.appendChild(h)}}async function L(g){const w=++I;e("搜索中…"),a();try{const z=await p(g);if(w!==I)return;const k=(z==null?void 0:z.items)||[];e(`共 ${k.length} 项`),v(k)}catch(z){if(w!==I)return;e(`搜索失败：${(z==null?void 0:z.message)||String(z)}`)}}function b(){const g=String(n.value||"").trim();if(T=g,y&&clearTimeout(y),!g||g.length<M){I++,e("请输入关键字开始搜索。"),a();return}y=setTimeout(()=>L(g),l)}return n.addEventListener("input",b),{refresh:()=>b(),setQuery:g=>{n.value=g||"",b()},clear:()=>{n.value="",b()},focus:()=>n.focus(),getQuery:()=>T}}function Tt(n){const t={};for(const[f,p]of Object.entries(n||{}))try{t[f]=p()}catch{t[f]=null}return t}function wt(n,t){for(const[f,p]of Object.entries(n||{}))typeof p=="function"&&p(t?t[f]:null)}function At(n){const{$:t,openModal:f,closeModal:p,setInvalid:_,clearInvalid:E,norm:l,isSlug:M,apiFetch:y,getToken:T,showConfirmFlow:I}=n,e=m=>{const H=t(m);return H||console.warn(`[org] missing element #${m}`),H},a=e("orgModal"),v=e("orgModalTitle"),L=e("orgClose"),b=e("orgShortName"),g=e("orgFullName"),w=e("orgEstablishYear"),z=e("orgSlug"),k=e("orgDescription"),h=e("orgShortNameErr"),N=e("orgEstablishYearErr"),u=e("orgSlugErr"),U=e("orgActionsCreate"),O=e("orgActionsEdit"),x=e("orgReset"),c=e("orgSubmit"),F=e("orgEditReset"),i=e("orgEditCancel"),s=e("orgEditSubmit");if(!a||!v||!L||!b||!g||!w||!z||!h||!N||!u||!U||!O||!x||!c||!F||!i||!s){console.warn("[org] mountOrganizationAdmin skipped due to missing DOM nodes.");return}let $=null,P=null;function A(){return{organization_short_name:()=>l(b.value),organization_full_name:()=>l(g.value)||"",establish_year:()=>l(w.value)||"",organization_slug:()=>l(z.value),organization_description:()=>l(k==null?void 0:k.value)||""}}function Q(){return{organization_short_name:m=>{b.value=m??""},organization_full_name:m=>{g.value=m??""},establish_year:m=>{w.value=m??""},organization_slug:m=>{z.value=m??""},organization_description:m=>{k&&(k.value=m??"")}}}function W(){E(b,h),E(w,N),E(z,u)}function V(){W();const m=l(b.value),H=l(z.value),R=l(w.value);let J=!0;if(m||(_(b,h,"企业简称为必填。"),J=!1),H?M(H)||(_(z,u,"slug 仅允许 a-z / 0-9 / 连字符 -（建议小写）。"),J=!1):(_(z,u,"slug 为必填。"),J=!1),R){const it=Number(R),at=new Date().getFullYear();!Number.isFinite(it)||!Number.isInteger(it)?(_(w,N,"成立时间必须为整数年份。"),J=!1):(it<1990||it>at)&&(_(w,N,`成立时间范围：1990 ~ ${at}。`),J=!1)}return J}function Y(){const m=l(b.value),H=l(g.value),R=l(z.value),J=l(w.value),it=l(k==null?void 0:k.value);return{organization_short_name:m,organization_full_name:H||null,establish_year:J?Number(J):null,organization_slug:R,organization_description:it||null}}function X(){$=null,P=null,v.textContent="添加企业/机构",U.style.display="",O.style.display="none"}function tt({organization:m}){$=m.organization_id,v.textContent="编辑企业/机构（基础信息）",U.style.display="none",O.style.display="",wt(Q(),{organization_short_name:m.organization_short_name??"",organization_full_name:m.organization_full_name??"",establish_year:m.establish_year??"",organization_slug:m.organization_slug??"",organization_description:m.organization_description??""}),P=Tt(A())}function Z(){wt(Q(),{organization_short_name:"",organization_full_name:"",establish_year:"",organization_slug:"",organization_description:""})}L.addEventListener("click",()=>p(a)),i.addEventListener("click",()=>p(a)),x.addEventListener("click",()=>{W(),Z()}),F.addEventListener("click",()=>{W(),P&&wt(Q(),P)}),c.addEventListener("click",async()=>{if(!V())return;const m=Y(),H=T();c.disabled=!0,x.disabled=!0,await I({titleLoading:"添加中",bodyLoading:"写入企业/机构中…",action:async()=>{var J;const R=await y("/api/admin/organization",{method:"POST",token:H,body:m});return p(a),Z(),`✅ 添加成功：organization_id = ${((J=R==null?void 0:R.organization)==null?void 0:J.organization_id)??(R==null?void 0:R.organization_id)??"（未返回）"}`}}),c.disabled=!1,x.disabled=!1}),s.addEventListener("click",async()=>{if(!V())return;if(!$)throw new Error("Missing organization_id");const m=Y(),H=T();s.disabled=!0,F.disabled=!0,i.disabled=!0,await I({titleLoading:"更新中",bodyLoading:"更新企业/机构中…",action:async()=>{var J;const R=await y(`/api/admin/organization/${$}`,{method:"PATCH",token:H,body:m});return p(a),`✅ 更新成功：organization_id = ${((J=R==null?void 0:R.organization)==null?void 0:J.organization_id)??(R==null?void 0:R.organization_id)??"（未返回）"}`}}),s.disabled=!1,F.disabled=!1,i.disabled=!1});const S=e("btnOpenOrg"),j=e("btnOpenOrgEdit"),o=e("orgSearchModal"),C=e("orgSearchClose"),r=e("orgSearchInput"),d=e("orgSearchList"),B=e("orgSearchStatus"),q=e("orgInfoModal"),D=e("orgInfoClose"),et=e("orgInfoCancel"),nt=e("orgInfoEdit"),K=e("orgInfoBody");if([a,v,L,b,w,z,h,N,u,U,O,x,c,F,i,s,S,j,o,C,r,d,B,q,D,et,nt,K].some(m=>!m))return;const G=q.querySelector(".modal-title");let gt=null;C.addEventListener("click",()=>p(o)),D.addEventListener("click",()=>p(q)),et.addEventListener("click",()=>p(q));function It(m){const H=l(m==null?void 0:m.organization_full_name),R=l(m==null?void 0:m.organization_short_name);return H||R||"（未命名企业/机构）"}function $t(m){function H(R,J){const it=document.createElement("div");it.className="kv";const at=document.createElement("div");at.className="kv-k",at.textContent=R;const ht=document.createElement("div");return ht.className="kv-v",ht.textContent=J==null||J===""?"—":String(J),it.appendChild(at),it.appendChild(ht),it}G&&(G.textContent=`企业/机构信息：${It(m)}`),K.innerHTML="",K.appendChild(H("企业简称",m.organization_short_name)),K.appendChild(H("企业全称",m.organization_full_name)),K.appendChild(H("成立时间",m.establish_year)),K.appendChild(H("Slug",m.organization_slug)),K.appendChild(H("描述",m.organization_description)),K.appendChild(H("ID",m.organization_id))}const Ct=St({inputEl:r,listEl:d,statusEl:B,searchFn:async m=>{const H=T();return await y(`/api/admin/organization/search?q=${encodeURIComponent(m)}`,{token:H})},renderItem:m=>({title:m.display_name||m.organization_short_name||"（未命名）",subtitle:[m.organization_full_name?`全称：${m.organization_full_name}`:null,m.organization_short_name?`简称：${m.organization_short_name}`:null,m.organization_slug?`slug：${m.organization_slug}`:null].filter(Boolean).join(" · ")}),onPick:async m=>{const H=T();try{B.textContent="读取详情中…";const R=await y(`/api/admin/organization/${m.organization_id}`,{token:H});gt=R.organization??R,$t(gt),f(q)}catch(R){B.textContent=`读取失败：${(R==null?void 0:R.message)||String(R)}`}}});nt.addEventListener("click",()=>{gt&&(p(q),p(o),tt({organization:gt}),W(),f(a))}),S.addEventListener("click",()=>{X(),W(),Z(),f(a)}),j.addEventListener("click",()=>{f(o),Ct.clear(),Ct.focus()})}function zt({selectEl:n,rowsWhenMain:t=[],rowsWhenAlias:f=[],onModeChange:p=null}={}){if(!n)throw new Error("createAliasSwitch: missing selectEl");const _=e=>e?Array.isArray(e)?e.filter(Boolean):[e].filter(Boolean):[],E=_(t),l=_(f);function M(e,a){e&&(e.style.display=a?"":"none")}function y(){return String(n.value||"").toLowerCase()==="yes"?"yes":"no"}function T(e=y(),{emit:a=!1}={}){const v=e==="yes"?"yes":"no",L=v==="yes";for(const b of E)M(b,!L);for(const b of l)M(b,L);a&&typeof p=="function"&&p(v)}function I(){return y()==="yes"}return n.addEventListener("change",()=>{T(y(),{emit:!0})}),T(y(),{emit:!1}),{getMode:y,isAlias:I,applyMode:T}}function lt({pickedEl:n,clearBtn:t,inputEl:f,statusEl:p,listEl:_,errEl:E=null,searchFn:l,renderItem:M,getId:y=a=>(a==null?void 0:a.id)??(a==null?void 0:a.value)??(a==null?void 0:a.organization_id)??(a==null?void 0:a.security_domain_id)??(a==null?void 0:a.security_product_id),getLabel:T=(a,v)=>(v==null?void 0:v.title)??String(y(a)??""),emptyText:I="未选择（请在下方搜索并点击一个选项）",onPick:e=null}={}){if(!n)throw new Error("createSingleSelectPicker: missing pickedEl");if(!t)throw new Error("createSingleSelectPicker: missing clearBtn");if(!f)throw new Error("createSingleSelectPicker: missing inputEl");if(!p)throw new Error("createSingleSelectPicker: missing statusEl");if(!_)throw new Error("createSingleSelectPicker: missing listEl");if(typeof l!="function")throw new Error("createSingleSelectPicker: missing searchFn");if(typeof M!="function")throw new Error("createSingleSelectPicker: missing renderItem");let a=null;function v(u){E&&(E.textContent=u||"",E.style.display=u?"":"none")}function L(u){n.textContent=u||I}function b(u){t.style.display=u?"":"none"}function g(u){a=u?{...u}:null,a?(L(a.label||String(a.id??"")),b(!0),v("")):(L(I),b(!1))}function w(){return a}function z(){g(null),f&&(f.value=""),v("")}t.addEventListener("click",()=>{z()});const k=St({inputEl:f,listEl:_,statusEl:p,searchFn:l,renderItem:M,onPick:async u=>{const U=M(u)||{},O=y(u),x=T(u,U),c={id:O,label:x,raw:u};g(c),typeof e=="function"&&await e(u,c)}});function h(u="此项为必填。"){return a&&a.id!==null&&a.id!==void 0&&String(a.id)!==""?(v(""),!0):(v(u),!1)}function N(){var u;typeof(k==null?void 0:k.focus)=="function"?k.focus():(u=f==null?void 0:f.focus)==null||u.call(f)}return g(null),{search:k,getSelected:w,setSelected:g,clear:z,validateRequired:h,focus:N}}function Mt(n){const{$:t,openModal:f,closeModal:p,setInvalid:_,clearInvalid:E,norm:l,isSlug:M,apiFetch:y,getToken:T,showConfirmFlow:I}=n,e=t("btnOpenDomain"),a=t("domainModal"),v=t("domainClose"),L=t("domainName"),b=t("domainNameErr"),g=t("domainIsAlias"),w=t("domainIsAliasErr"),z=t("domainSlugRow"),k=t("domainSlug"),h=t("domainSlugErr"),N=t("domainDescRow"),u=t("domainDesc"),U=t("domainAliasTargetRow"),O=t("domainAliasTargetPicked"),x=t("domainAliasTargetClear"),c=t("domainAliasTargetSearch"),F=t("domainAliasTargetStatus"),i=t("domainAliasTargetList"),s=t("domainAliasTargetErr"),$=t("domainReset"),P=t("domainSubmit"),A=[["btnOpenDomain",e],["domainModal",a],["domainClose",v],["domainName",L],["domainNameErr",b],["domainIsAlias",g],["domainIsAliasErr",w],["domainSlugRow",z],["domainSlug",k],["domainSlugErr",h],["domainReset",$],["domainSubmit",P]];for(const[S,j]of A)if(!j){console.warn(`[domain] missing element #${S}`);return}v.addEventListener("click",()=>p(a));function Q(S,j){S&&(S.textContent="",S.style.display="none")}function W(){E(L,b),E(g,w),E(k,h),Q(s)}const V=lt({pickedEl:O,clearBtn:x,inputEl:c,statusEl:F,listEl:i,errEl:s,emptyText:"未选择（请在下方搜索并点击一个安全领域）",searchFn:async S=>{const j=T();return await y(`/api/admin/dropdowns/domains?q=${encodeURIComponent(S)}`,{token:j})},renderItem:S=>({title:S.security_domain_name||S.domain_name||S.name||"（未命名领域）",subtitle:[S.cybersecurity_domain_slug?`slug：${S.cybersecurity_domain_slug}`:null,S.security_domain_id?`ID：${S.security_domain_id}`:null].filter(Boolean).join(" · ")}),getId:S=>S.security_domain_id??S.id,getLabel:(S,j)=>(j==null?void 0:j.title)??String(S.security_domain_id??S.id??"")}),Y=zt({selectEl:g,rowsWhenMain:[z,N],rowsWhenAlias:[U],onModeChange:S=>{W(),S==="yes"?(k.value="",u&&(u.value="")):V.clear()}});function X(){L.value="",g.value="no",k.value="",u&&(u.value=""),V.clear(),W(),Y.applyMode("no",{emit:!1})}function tt(){W();let S=!0;if(l(L.value)||(_(L,b,"安全领域名称为必填。"),S=!1),Y.getMode()==="no"){const C=l(k.value);C?M(C)||(_(k,h,"slug 仅允许 a-z / 0-9 / 连字符 -（建议小写）。"),S=!1):(_(k,h,"安全领域 slug 为必填。"),S=!1)}else V.validateRequired("请选择“同等安全领域”。")||(S=!1);return S}function Z(){const S=l(L.value),j=Y.getMode(),o=l(u==null?void 0:u.value);if(j==="no"){const r=l(k.value);return{mode:"main",payload:{security_domain_name:S,cybersecurity_domain_slug:r,security_domain_description:o||null}}}const C=V.getSelected();return{mode:"alias",payload:{security_domain_alias_name:S,security_domain_id:C==null?void 0:C.id}}}$.addEventListener("click",()=>X()),P.addEventListener("click",async()=>{if(!tt())return;const S=T(),{mode:j,payload:o}=Z();P.disabled=!0,$.disabled=!0,await I({titleLoading:j==="main"?"添加中":"添加别名中",bodyLoading:j==="main"?"写入安全领域中…":"写入安全领域别名中…",action:async()=>{const r=await y(j==="main"?"/api/admin/domain":"/api/admin/domain/alias",{method:"POST",token:S,body:o});return p(a),X(),`✅ 添加成功：${(r==null?void 0:r.id)??(r==null?void 0:r.security_domain_id)??(r==null?void 0:r.security_domain_alias_id)??"（未返回）"}`}}),P.disabled=!1,$.disabled=!1}),e.addEventListener("click",()=>{X(),f(a),L.focus()})}function Nt(n){return encodeURIComponent(String(n??""))}function Pt({apiFetch:n,getToken:t,path:f}){if(!n)throw new Error("makeDropdownSearch: missing apiFetch");if(!t)throw new Error("makeDropdownSearch: missing getToken");if(!f)throw new Error("makeDropdownSearch: missing path");return async p=>{const _=t();return await n(`${f}?q=${Nt(p)}`,{token:_})}}function Ot({apiFetch:n,getToken:t}){return Pt({apiFetch:n,getToken:t,path:"/api/admin/dropdowns/domain_union"})}function Rt({apiFetch:n,getToken:t}){return Pt({apiFetch:n,getToken:t,path:"/api/admin/dropdowns/product_union"})}function Dt({rootEl:n,fetchItems:t,getId:f=E=>E.security_domain_id??E.domain_id??E.id,getLabel:p=E=>E.security_domain_name??E.domain_name??E.name??`ID ${f(E)}`,onChangeSummary:_=null}={}){if(!n)return console.warn("[product] mountDomainMultiSelect skipped: missing rootEl"),{getConfirmedIds:()=>[],clear:()=>{},focus:()=>{}};let E=new Map,l=new Map,M=!1;n.innerHTML="";const y=document.createElement("div");y.className="ia-ms-head";const T=document.createElement("div");T.className="ia-ms-title",T.textContent="已选择安全领域（多选）";const I=document.createElement("div");I.className="ia-ms-actions";const e=document.createElement("button");e.type="button",e.className="ia-ms-iconbtn",e.textContent="▾";const a=document.createElement("button");a.type="button",a.className="ia-ms-iconbtn",a.textContent="×",I.appendChild(e),I.appendChild(a),y.appendChild(T),y.appendChild(I);const v=document.createElement("div");v.className="ia-ms-summary",v.textContent="未选择（点击 ▾ 展开后搜索并勾选，点“确认”生效）";const L=document.createElement("div");L.className="ia-ms-panel";const b=document.createElement("input");b.className="input",b.type="text",b.placeholder="搜索安全领域 name / alias / slug ...";const g=document.createElement("div");g.className="hint",g.style.marginTop="6px",g.textContent="输入关键字开始搜索。";const w=document.createElement("div");w.style.marginTop="10px";const z=document.createElement("div");z.className="modal-actions",z.style.justifyContent="flex-start",z.style.marginTop="10px";const k=document.createElement("button");k.type="button",k.className="btn btn-primary",k.textContent="确认",z.appendChild(k),L.appendChild(b),L.appendChild(g),L.appendChild(w),L.appendChild(z),n.appendChild(y),n.appendChild(v),n.appendChild(L);function h(){const x=Array.from(E.values());x.length?v.textContent=x.map(c=>`• ${p(c)}`).join(`
`):v.textContent="未选择（点击 ▾ 展开后搜索并勾选，点“确认”生效）",typeof _=="function"&&_(Array.from(E.keys()),x)}function N(x){M=!!x,L.style.display=M?"block":"none",e.textContent=M?"▴":"▾",M&&b.focus()}function u(x){if(w.innerHTML="",!x.length){const c=document.createElement("div");c.className="hint",c.textContent="无结果。",w.appendChild(c);return}for(const c of x){const F=f(c);if(F==null)continue;const i=document.createElement("div");i.className="es-item",i.style.display="flex",i.style.alignItems="flex-start",i.style.gap="10px";const s=document.createElement("input");s.type="checkbox",s.style.marginTop="3px",s.checked=l.has(F),s.addEventListener("change",()=>{s.checked?l.set(F,c):l.delete(F)});const $=document.createElement("div");$.style.flex="1 1 auto";const P=document.createElement("div");P.className="es-title",P.textContent=p(c);const A=document.createElement("div");A.className="es-subtitle",A.textContent=[c.cybersecurity_domain_slug?`slug：${c.cybersecurity_domain_slug}`:null,c.security_domain_id?`ID：${c.security_domain_id}`:null].filter(Boolean).join(" · "),$.appendChild(P),A.textContent&&$.appendChild(A),i.appendChild(s),i.appendChild($),w.appendChild(i)}}async function U(){const x=String(b.value||"").trim();if(!x){g.textContent="输入关键字开始搜索。",w.innerHTML="";return}try{g.textContent="搜索中…";const c=await t(x),F=(c==null?void 0:c.items)||(c==null?void 0:c.data)||[];g.textContent=`结果：${F.length}`,u(F)}catch(c){g.textContent=`搜索失败：${(c==null?void 0:c.message)||String(c)}`,w.innerHTML=""}}let O=null;return b.addEventListener("input",()=>{O&&clearTimeout(O),O=setTimeout(U,250)}),e.addEventListener("click",()=>{M?N(!1):(l=new Map(E),N(!0))}),a.addEventListener("click",()=>{E=new Map,l=new Map,h()}),k.addEventListener("click",()=>{E=new Map(l),h(),N(!1)}),N(!1),h(),{getConfirmedIds:()=>Array.from(E.keys()),clear:()=>{E=new Map,l=new Map,h()},focus:()=>b.focus()}}function Ft(n){const{$:t,openModal:f,closeModal:p,setInvalid:_,clearInvalid:E,norm:l,isSlug:M,apiFetch:y,getToken:T,showConfirmFlow:I}=n,e=r=>{const d=t(r);return d||console.warn(`[product] missing element #${r}`),d},a=e("btnOpenProduct"),v=e("productModal"),L=e("productClose"),b=e("productName"),g=e("productNameErr"),w=e("productIsAlias"),z=e("productIsAliasErr"),k=e("productSlugRow"),h=e("productSlug"),N=e("productSlugErr"),u=e("productDomainsRow"),U=e("productDomains"),O=e("productDomainsErr"),x=e("productDescRow"),c=e("productDesc"),F=e("productAliasTargetRow"),i=e("productAliasTargetPicked"),s=e("productAliasTargetClear"),$=e("productAliasTargetSearch"),P=e("productAliasTargetStatus"),A=e("productAliasTargetList"),Q=e("productAliasTargetErr"),W=e("productReset"),V=e("productSubmit");if(!a||!v||!L||!b||!g||!w||!z||!k||!h||!N||!u||!U||!O||!x||!c||!F||!i||!s||!$||!P||!A||!Q||!W||!V){console.warn("[product] mountProductAdmin skipped due to missing DOM nodes.");return}L.addEventListener("click",()=>p(v));function Y(){E(b,g),E(w,z),E(h,N),O&&(O.textContent="",O.style.display="none"),Q&&(Q.textContent="",Q.style.display="none")}function X(r){O&&(O.textContent=r||"",O.style.display=r?"":"none")}const tt=Dt({rootEl:U,fetchItems:Ot({apiFetch:y,getToken:T}),getId:r=>r.security_domain_id??r.normalized_id??r.domain_id??r.id,getLabel:r=>r.security_domain_name??r.domain_name??r.name??"（未命名领域）"}),Z=lt({pickedEl:i,clearBtn:s,inputEl:$,statusEl:P,listEl:A,errEl:Q,emptyText:"未选择（请在下方搜索并点击一个安全产品）",searchFn:async r=>{const d=T();return await y(`/api/admin/dropdowns/products?q=${encodeURIComponent(r)}`,{token:d})},renderItem:r=>({title:r.security_product_name||r.product_name||r.name||"（未命名产品）",subtitle:[r.security_product_slug?`slug：${r.security_product_slug}`:null,r.security_product_id?`ID：${r.security_product_id}`:null].filter(Boolean).join(" · ")}),getId:r=>r.security_product_id??r.id,getLabel:(r,d)=>(d==null?void 0:d.title)??String(r.security_product_id??r.id??"")}),S=zt({selectEl:w,rowsWhenMain:[k,u,x],rowsWhenAlias:[F],onModeChange:r=>{Y(),r==="yes"?(h.value="",c&&(c.value=""),tt.clear(),X("")):Z.clear()}});function j(){b.value="",w.value="no",h.value="",c&&(c.value=""),tt.clear(),Z.clear(),Y(),S.applyMode("no",{emit:!1})}function o(){Y();let r=!0;if(l(b.value)||(_(b,g,"安全产品名称为必填。"),r=!1),S.getMode()==="no"){const q=l(h.value);q?M(q)||(_(h,N,"slug 仅允许 a-z / 0-9 / 连字符 -（建议小写）。"),r=!1):(_(h,N,"安全产品 slug 为必填。"),r=!1),tt.getConfirmedIds().length||(X("请至少选择 1 个对应安全领域。"),r=!1)}else Z.validateRequired("请选择“归属安全产品”。")||(r=!1);return r}function C(){const r=l(b.value),d=S.getMode(),B=l(c==null?void 0:c.value);if(d==="no"){const D=l(h.value),et=tt.getConfirmedIds();return{mode:"main",payload:{security_product_name:r,security_product_slug:D,security_product_description:B||null,domains:et}}}const q=Z.getSelected();return{mode:"alias",payload:{security_product_alias_name:r,security_product_id:q==null?void 0:q.id}}}W.addEventListener("click",()=>j()),V.addEventListener("click",async()=>{if(!o())return;const r=T(),{mode:d,payload:B}=C();V.disabled=!0,W.disabled=!0,await I({titleLoading:d==="main"?"添加中":"添加别名中",bodyLoading:d==="main"?"写入安全产品中…":"写入安全产品别名中…",action:async()=>{const D=await y(d==="main"?"/api/admin/product":"/api/admin/product/alias",{method:"POST",token:r,body:B});return p(v),j(),`✅ 添加成功：${(D==null?void 0:D.id)??(D==null?void 0:D.security_product_id)??(D==null?void 0:D.security_product_alias_id)??"（未返回）"}`}}),V.disabled=!1,W.disabled=!1}),a.addEventListener("click",()=>{j(),f(v),b.focus()})}function ft(n){const t=typeof n=="number"?n:Number(String(n??"").trim());return!Number.isFinite(t)||!Number.isInteger(t)?null:t}function pt(n,{min:t=1990,max:f=new Date().getFullYear()}={}){const p=String(n||"").trim();if(!p)return{ok:!0,value:null};const _=Number(p);return!Number.isFinite(_)||!Number.isInteger(_)?{ok:!1,msg:"必须为整数年份。"}:_<t||_>f?{ok:!1,msg:`年份范围：${t} ~ ${f}。`}:{ok:!0,value:_}}function Yt(n){const{$:t,openModal:f,closeModal:p,apiFetch:_,getToken:E,showConfirmFlow:l}=n,M=t("btnOpenOrgProduct"),y=t("orgProductModal"),T=t("orgProductClose"),I=t("orgProductOrgErr"),e=t("orgProductProdErr"),a=t("orgProductReleaseYear"),v=t("orgProductReleaseYearErr"),L=t("orgProductEndYear"),b=t("orgProductEndYearErr"),g=t("orgProductScore"),w=t("orgProductScoreErr"),z=t("orgProductReset"),k=t("orgProductSubmit");if(!M||!y||!T||!z||!k||!a||!L||!g||!w){console.warn("[orgProduct] mount skipped: missing required DOM nodes.");return}function h(i,s){i&&(i.textContent=s||"",i.style.display=s?"":"none")}function N(){h(I,""),h(e,""),h(v,""),h(b,""),h(w,"")}T.addEventListener("click",()=>p(y));const u=lt({pickedEl:t("orgProductOrgPicked"),clearBtn:t("orgProductOrgClear"),inputEl:t("orgProductOrgSearch"),statusEl:t("orgProductOrgStatus"),listEl:t("orgProductOrgList"),errEl:I,emptyText:"未选择（请在下方搜索并点击一个企业/机构）",searchFn:async i=>{const s=E();return await _(`/api/admin/organization/search?q=${encodeURIComponent(i)}`,{token:s})},renderItem:i=>({title:i.display_name||i.organization_short_name||"（未命名）",subtitle:[i.organization_full_name?`全称：${i.organization_full_name}`:null,i.organization_short_name?`简称：${i.organization_short_name}`:null,i.organization_slug?`slug：${i.organization_slug}`:null].filter(Boolean).join(" · ")}),getId:i=>i.organization_id,getLabel:(i,s)=>(s==null?void 0:s.title)??String(i.organization_id)}),U=lt({pickedEl:t("orgProductProdPicked"),clearBtn:t("orgProductProdClear"),inputEl:t("orgProductProdSearch"),statusEl:t("orgProductProdStatus"),listEl:t("orgProductProdList"),errEl:e,emptyText:"未选择（请在下方搜索并点击一个安全产品/别名）",searchFn:Rt({apiFetch:_,getToken:E}),renderItem:i=>({title:i.name||i.security_product_name||i.security_product_alias_name||"（未命名产品）",subtitle:[i.type?`类型：${i.type}`:null,i.security_product_slug?`slug：${i.security_product_slug}`:null,i.product_id??i.security_product_id??i.id?`ID：${i.product_id??i.security_product_id??i.id}`:null].filter(Boolean).join(" · ")}),getId:i=>i.product_id??i.security_product_id??i.normalized_id??i.normalized_security_product_id??i.id,getLabel:(i,s)=>(s==null?void 0:s.title)??String(i.product_id??i.security_product_id??i.id??"")});function O(){u.clear(),U.clear(),a.value="",L.value="",g.value="",N()}function x(){var X,tt,Z;N();let i=!0;u.validateRequired("请选择企业/机构。")||(i=!1),U.validateRequired("请选择安全产品/别名。")||(i=!1);const s=u.getSelected();ft(((X=s==null?void 0:s.raw)==null?void 0:X.organization_id)??(s==null?void 0:s.id))===null&&(h(I,"企业 ID 无效（必须为数字）。请重新选择。"),i=!1);const P=U.getSelected();ft(((tt=P==null?void 0:P.raw)==null?void 0:tt.product_id)??((Z=P==null?void 0:P.raw)==null?void 0:Z.security_product_id)??(typeof(P==null?void 0:P.id)=="string"&&P.id.includes(":")?P.id.split(":")[1]:P==null?void 0:P.id))===null&&(h(e,"产品 ID 无效（必须为数字）。请重新选择。"),i=!1);const Q=new Date().getFullYear(),W=pt(a.value,{min:1990,max:Q}),V=pt(L.value,{min:1990,max:Q});W.ok||(h(v,W.msg),i=!1),V.ok||(h(b,V.msg),i=!1);const Y=(g.value??"").toString().trim();if(Y!==""){const S=Number(Y);(!Number.isFinite(S)||S<1||S>10)&&(h(w,"评分必须在 1~10 之间（或留空）。"),i=!1)}return i}function c(){var X,tt,Z;const i=new Date().getFullYear(),s=u.getSelected(),$=U.getSelected(),P=ft(((X=s==null?void 0:s.raw)==null?void 0:X.organization_id)??(s==null?void 0:s.id)),A=ft(((tt=$==null?void 0:$.raw)==null?void 0:tt.product_id)??((Z=$==null?void 0:$.raw)==null?void 0:Z.security_product_id)??(typeof($==null?void 0:$.id)=="string"&&$.id.includes(":")?$.id.split(":")[1]:$==null?void 0:$.id));if(P===null)throw new Error("organization_id must be a number");if(A===null)throw new Error("security_product_id must be a number");const Q=pt(a.value,{min:1990,max:i}),W=pt(L.value,{min:1990,max:i}),V=(g.value??"").toString().trim(),Y=V===""?null:Number(V);return{organization_id:P,security_product_id:A,product_release_year:Q.value,product_end_year:W.value,recommendation_score:Y}}async function F(){if(!x())return;const i=E(),s=c(),$=async()=>{const P=await _("/api/admin/org_product",{method:"POST",token:i,body:s}),A=(P==null?void 0:P.organization_product)??P,Q=["✅ 添加成功：organization_product",`organization_id = ${(A==null?void 0:A.organization_id)??s.organization_id}`,`security_product_id = ${(A==null?void 0:A.security_product_id)??s.security_product_id}`,`product_release_year = ${(A==null?void 0:A.product_release_year)??s.product_release_year??"—"}`,`product_end_year = ${(A==null?void 0:A.product_end_year)??s.product_end_year??"—"}`,`recommendation_score = ${(A==null?void 0:A.recommendation_score)??s.recommendation_score??"—"}`].join(`
`);return p(y),O(),Q};if(typeof l=="function")await l({titleLoading:"添加中",bodyLoading:"写入企业产品中…",action:$});else{const P=await $();alert(P)}}z.addEventListener("click",()=>O()),k.addEventListener("click",async()=>{k.disabled=!0,z.disabled=!0;try{await F()}catch(i){console.error("[orgProduct] submit failed:",i);const s=(i==null?void 0:i.message)||String(i);h(e,`❌ 失败：${s}`)}finally{k.disabled=!1,z.disabled=!1}}),M.addEventListener("click",()=>{O(),f(y),u.focus()})}function vt(n){const t=typeof n=="number"?n:Number(String(n??"").trim());return!Number.isFinite(t)||!Number.isInteger(t)?null:t}function kt(n,{min:t=1990,max:f=new Date().getFullYear()}={}){const p=String(n||"").trim();if(!p)return{ok:!0,value:null};const _=Number(p);return!Number.isFinite(_)||!Number.isInteger(_)?{ok:!1,msg:"必须为整数年份。"}:_<t||_>f?{ok:!1,msg:`年份范围：${t} ~ ${f}。`}:{ok:!0,value:_}}function Bt(n){const{$:t,openModal:f,closeModal:p,apiFetch:_,getToken:E,showConfirmFlow:l}=n,M=t("btnOpenOrgProductEdit"),y=t("orgProductEditModal"),T=t("orgProductEditClose"),I=t("orgProductEditOrgErr"),e=t("orgProductEditListStatus"),a=t("orgProductEditList"),v=t("orgProductEditItemModal"),L=t("orgProductEditItemClose"),b=t("orgProductEditItemCancel"),g=t("orgProductEditItemOrgName"),w=t("orgProductEditItemProdName"),z=t("orgProductEditItemReleaseYear"),k=t("orgProductEditItemReleaseYearErr"),h=t("orgProductEditItemEndYear"),N=t("orgProductEditItemEndYearErr"),u=t("orgProductEditItemScore"),U=t("orgProductEditItemScoreErr"),O=t("orgProductEditItemPreview"),x=t("orgProductEditItemSubmit");if(!M||!y||!T||!I||!e||!a||!v||!u||!U){console.warn("[orgProductEdit] mount skipped: missing required DOM nodes.");return}function c(o,C){o&&(o.textContent=C||"",o.style.display=C?"":"none")}function F(o){e.textContent=o||""}function i(){a.innerHTML=""}function s(o){return String(o??"").replace(/[&<>"']/g,C=>({"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"})[C])}T.addEventListener("click",()=>p(y)),L&&L.addEventListener("click",()=>p(v)),b&&b.addEventListener("click",()=>p(v));const $=lt({pickedEl:t("orgProductEditOrgPicked"),clearBtn:t("orgProductEditOrgClear"),inputEl:t("orgProductEditOrgSearch"),statusEl:t("orgProductEditOrgStatus"),listEl:t("orgProductEditOrgList"),errEl:I,emptyText:"未选择（请在下方搜索并点击一个企业/机构）",searchFn:async o=>{const C=E();return await _(`/api/admin/organization/search?q=${encodeURIComponent(o)}`,{token:C})},renderItem:o=>({title:o.display_name||o.organization_short_name||"（未命名）",subtitle:[o.organization_full_name?`全称：${o.organization_full_name}`:null,o.organization_short_name?`简称：${o.organization_short_name}`:null,o.organization_slug?`slug：${o.organization_slug}`:null].filter(Boolean).join(" · ")}),getId:o=>o.organization_id,getLabel:(o,C)=>(C==null?void 0:C.title)??String(o.organization_id),onPick:async()=>{await W()}});async function P(o){const C=E();return await _(`/api/admin/org_product?organization_id=${encodeURIComponent(o)}`,{token:C})}function A(){var r;const o=$.getSelected();return vt(((r=o==null?void 0:o.raw)==null?void 0:r.organization_id)??(o==null?void 0:o.id))}function Q(){var C,r;const o=$.getSelected();return(o==null?void 0:o.label)||((C=o==null?void 0:o.raw)==null?void 0:C.display_name)||((r=o==null?void 0:o.raw)==null?void 0:r.organization_short_name)||""}async function W(){c(I,""),i();const o=A();if(o===null){F("请选择企业后查看该企业已录入的产品。");return}F("加载中…");let C;try{C=await P(o)}catch(d){console.error("[orgProductEdit] list failed:",d),F("加载失败。"),c(I,`❌ 失败：${(d==null?void 0:d.message)||String(d)}`);return}const r=(C==null?void 0:C.items)||[];if(!r.length){F("该企业目前没有已录入的产品。");return}F(`共 ${r.length} 条：`),a.innerHTML=r.map(d=>{var nt,K,ot;const B=((nt=d.product)==null?void 0:nt.security_product_name)||`#${d.security_product_id}`,q=(K=d.product)!=null&&K.security_product_slug?`slug：${d.product.security_product_slug}`:null,D=(d.product_release_year??"")===""||d.product_release_year===null?"—":d.product_release_year,et=(d.product_end_year??"")===""||d.product_end_year===null?"—":d.product_end_year;return`
        <div class="es-item" data-opid="${s(d.organization_product_id)}" data-spid="${s(d.security_product_id)}" data-score="${s(d.recommendation_score??"")}"
             data-name="${s(B)}" data-slug="${s(((ot=d.product)==null?void 0:ot.security_product_slug)||"")}"
             data-y1="${s(d.product_release_year??"")}" data-y2="${s(d.product_end_year??"")}">
          <div class="es-title">${s(B)}</div>
          <div class="es-subtitle">
            ${[q,`发布：${s(D)}`,`终止：${s(et)}`,`op_id：${s(d.organization_product_id)}`].filter(Boolean).join(" · ")}
          </div>
          <div class="modal-actions" style="justify-content:flex-end; margin-top:10px;">
            <button class="btn" data-action="edit" type="button">编辑</button>
            <button class="btn" data-action="delete" type="button">删除</button>
          </div>
        </div>
      `}).join("")}async function V(o,C){const r=E(),d=async()=>(await _(`/api/admin/org_product/${encodeURIComponent(o)}`,{method:"DELETE",token:r}),`✅ 已删除：${C}（organization_product_id=${o}）`);await l({titleLoading:"删除中",bodyLoading:`正在删除：${C}
organization_product_id=${o}

请稍候…`,action:d}),await W()}let Y=null,X=!1;function tt(){Y=null,X=!1,O&&(O.textContent="",O.style.display="none"),c(k,""),c(N,""),c(U,""),z&&(z.value=""),h&&(h.value=""),u&&(u.value=""),x&&(x.textContent="确定（预览修改）")}function Z(o){var et,nt,K,ot,G;tt();const C=vt((et=o==null?void 0:o.dataset)==null?void 0:et.opid);if(C===null){alert("❌ 无效的 organization_product_id");return}const r=Q(),d=((nt=o.dataset)==null?void 0:nt.name)||"",B=((K=o.dataset)==null?void 0:K.y1)??"",q=((ot=o.dataset)==null?void 0:ot.y2)??"",D=((G=o.dataset)==null?void 0:G.score)??"";Y={organization_product_id:C,organization_name:r,product_name:d,old_release_year:B===""?null:Number(B),old_end_year:q===""?null:Number(q),old_score:D===""?null:Number(D)},g&&(g.textContent=r),w&&(w.textContent=d),z.value=(B??"")===""?"":String(B),h.value=(q??"")===""?"":String(q),u.value=(D??"")===""?"":String(D),f(v)}function S(){c(k,""),c(N,""),c(U,"");const o=new Date().getFullYear(),C=kt(z.value,{min:1990,max:o});if(!C.ok)return c(k,C.msg),null;const r=kt(h.value,{min:1990,max:o});if(!r.ok)return c(N,r.msg),null;const d=(u.value??"").toString().trim(),B=d===""?null:Number(d);return d!==""&&(!Number.isFinite(B)||B<1||B>10)?(c(U,"评分必须在 1~10 之间（或留空）。"),null):{product_release_year:C.value,product_end_year:r.value,recommendation_score:B}}async function j(){if(!Y)return;const o=S();if(!o)return;const C=E(),r=o.product_release_year??null,d=o.product_end_year??null,B=o.recommendation_score??null,q=Y.old_release_year??null,D=Y.old_end_year??null,et=Y.old_score??null,nt=[`企业：${Y.organization_name}`,`产品：${Y.product_name}`,"",`发布年份：${q??"—"}  ->  ${r??"—"}`,`终止年份：${D??"—"}  ->  ${d??"—"}`,`评分：${et??"—"}  ->  ${B??"—"}`,"","请再次点击“再次确定提交”以真正写入数据库。"].join(`
`);if(!X){X=!0,O?(O.textContent=nt,O.style.display=""):alert(nt),x&&(x.textContent="再次确定提交");return}const K=async()=>{const ot=await _(`/api/admin/org_product/${encodeURIComponent(Y.organization_product_id)}`,{method:"PATCH",token:C,body:o}),G=(ot==null?void 0:ot.organization_product)??ot;return["✅ 更新成功：organization_product",`organization_product_id = ${(G==null?void 0:G.organization_product_id)??Y.organization_product_id}`,`product_release_year = ${(G==null?void 0:G.product_release_year)??o.product_release_year??"—"}`,`product_end_year = ${(G==null?void 0:G.product_end_year)??o.product_end_year??"—"}`,`recommendation_score = ${(G==null?void 0:G.recommendation_score)??o.recommendation_score??"—"}`].join(`
`)};await l({titleLoading:"更新中",bodyLoading:`正在更新：${Y.product_name}
organization_product_id=${Y.organization_product_id}

请稍候…`,action:K}),p(v),await W()}a.addEventListener("click",async o=>{var D,et,nt,K;const C=(et=(D=o.target)==null?void 0:D.closest)==null?void 0:et.call(D,"button[data-action]");if(!C)return;const r=C.dataset.action,d=(K=(nt=o.target)==null?void 0:nt.closest)==null?void 0:K.call(nt,".es-item");if(!d)return;const B=vt(d.dataset.opid),q=d.dataset.name||`#${d.dataset.spid||""}`;if(r==="delete"){if(B===null)return alert("❌ 无效的 organization_product_id");if(!window.confirm(`确定要删除该企业产品记录吗？

企业：${Q()}
产品：${q}
organization_product_id=${B}`))return;try{await V(B,q)}catch(G){console.error("[orgProductEdit] delete failed:",G)}return}r==="edit"&&Z(d)}),x&&x.addEventListener("click",async()=>{x.disabled=!0;try{await j()}catch(o){console.error("[orgProductEdit] submit failed:",o),alert(`❌ 失败：${(o==null?void 0:o.message)||String(o)}`)}finally{x.disabled=!1}}),M.addEventListener("click",async()=>{c(I,""),i(),F("请选择企业后查看该企业已录入的产品。"),$.clear(),f(y),$.focus()})}function qt(){try{return xt({$:rt,openModal:st,closeModal:ct})}catch(n){return console.error("[admin] initConfirm failed:",n),{showConfirmFlow:async({action:t}={})=>typeof t=="function"?await t():null}}}const{showConfirmFlow:ut}=qt();function jt(){const n=rt("tokenInput");return n?Lt(n,{storageKey:"ia_admin_token"}):(console.warn("[admin] tokenInput not found; API calls may fail with unauthorized."),{getToken:()=>"",storageKey:"ia_admin_token"})}const{getToken:mt}=jt();try{At({$:rt,openModal:st,closeModal:ct,setInvalid:_t,clearInvalid:yt,norm:Et,isSlug:bt,apiFetch:dt,getToken:mt,showConfirmFlow:ut})}catch(n){console.error("[admin] mountOrganizationAdmin failed:",n)}try{Mt({$:rt,openModal:st,closeModal:ct,setInvalid:_t,clearInvalid:yt,norm:Et,isSlug:bt,apiFetch:dt,getToken:mt,showConfirmFlow:ut})}catch(n){console.error("[admin] mountDomainAdmin failed:",n)}try{Ft({$:rt,openModal:st,closeModal:ct,setInvalid:_t,clearInvalid:yt,norm:Et,isSlug:bt,apiFetch:dt,getToken:mt,showConfirmFlow:ut})}catch(n){console.error("[admin] mountProductAdmin failed:",n)}try{Yt({$:rt,openModal:st,closeModal:ct,setInvalid:_t,clearInvalid:yt,norm:Et,apiFetch:dt,getToken:mt,showConfirmFlow:ut})}catch(n){console.error("[admin] mountOrgProductAdmin failed:",n)}try{Bt({$:rt,openModal:st,closeModal:ct,apiFetch:dt,getToken:mt,showConfirmFlow:ut})}catch(n){console.error("[admin] mountOrgProductEditAdmin failed:",n)}
